# 3.5 Интеграционное тестирование и верификация функциональности модели

## Введение

Интеграционное тестирование имитационной модели платформы цифрового рубля направлено на верификацию корректности взаимодействия всех компонентов системы. Тестирование охватывает создание участников, выполнение базовых операций, работу распределенного реестра, криптографическую защиту, обработку офлайн-транзакций и работу смарт-контрактов.

## 3.5.1 Подход к тестированию

Тестирование выполняется по принципу интеграционного тестирования, где проверяется взаимодействие всех модулей системы в реальных сценариях использования. Все тесты выполняются на реальной системе с использованием фактических данных и проверкой результатов в базе данных.

**Таблица 3.5.1 – Области тестирования системы**

| Область тестирования | Компоненты | Критерии успеха |
|----------------------|------------|-----------------|
| Моделирование участников | Создание пользователей, банков, гос. организаций | Все участники успешно создаются, имеют корректные начальные балансы |
| Базовые операции | Пополнение кошелька, вывод средств, переводы C2C, C2B | Балансы корректно обновляются, транзакции создаются и фиксируются в блоках |
| Распределенный реестр | Создание блоков, целостность цепочки, Merkle-корни | Цепочка блоков валидна, хеши корректны, модификации обнаруживаются |
| Криптография | Подписание, проверка подписей, хеширование, хранение ключей | Все подписи валидны, хеши корректны, ключи безопасно хранятся |
| Офлайн-транзакции | Создание, синхронизация, разрешение конфликтов двойной траты | Офлайн-транзакции корректно создаются, синхронизируются, конфликты обнаруживаются |
| Смарт-контракты | Создание, автоматическое исполнение, обработка ошибок | Контракты создаются, исполняются в установленные сроки, ошибки обрабатываются |

**Пояснения к таблице 3.5.1:**

Область **Моделирование участников** проверяет создание через методы `create_users()`, `create_banks()`, `create_government_institutions()`. Область **Базовые операции** верифицирует операции через `exchange_to_digital()`, `exchange_from_digital()`, `create_online_transaction()`. Область **Распределенный реестр** проверяет целостность через `validate_chain()`. Область **Криптография** проверяет операции через `sign()`, `verify()`, `streebog_256()`. Область **Офлайн-транзакции** верифицирует работу через `create_offline_transaction()`, `sync_offline_transactions()`. Область **Смарт-контракты** проверяет исполнение через `create_smart_contract()`, `execute_due_contracts()`.

## 3.5.2 Тестирование моделирования участников

Тестирование моделирования участников верифицирует корректность создания пользователей различных типов, финансовых организаций и государственных учреждений.

**Таблица 3.5.2 – Тестовые сценарии моделирования участников**

| Тестовый сценарий | Описание | Ожидаемый результат |
|-------------------|----------|---------------------|
| Создание финансовой организации | Вызов `create_banks(1)` | Банк создан с корректным идентификатором, начальные балансы равны нулю |
| Создание физического лица | Вызов `create_users(1, "INDIVIDUAL")` | Пользователь создан с типом "INDIVIDUAL", привязан к банку, балансы равны нулю |
| Создание юридического лица | Вызов `create_users(1, "BUSINESS")` | Пользователь создан с типом "BUSINESS", привязан к банку, балансы равны нулю |
| Открытие цифрового кошелька | Вызов `open_digital_wallet(user_id)` | Поле `wallet_status` установлено в "OPEN" |

**Пояснения к таблице 3.5.2:**

Тесты проверяют корректность создания участников через методы `create_banks()`, `create_users()`, `create_government_institutions()` и установку статусов кошельков через `open_digital_wallet()`.

## 3.5.3 Тестирование базовых операций

Тестирование базовых операций верифицирует корректность пополнения кошельков, вывода средств и переводов между участниками.

**Таблица 3.5.3 – Тестовые сценарии базовых операций**

| Тестовый сценарий | Описание | Ожидаемый результат |
|-------------------|----------|---------------------|
| Пополнение кошелька (успешное) | Вызов `exchange_to_digital(user_id, amount)` | `fiat_balance` уменьшен, `digital_balance` увеличен, создан UTXO, транзакция в блоке |
| Пополнение кошелька (недостаточно средств) | Вызов `exchange_to_digital(user_id, amount)` | Вызвано исключение `ValueError`, балансы не изменились |
| Перевод C2C (успешный) | Вызов `create_online_transaction(sender_id, receiver_id, amount, "C2C")` | Балансы обновлены, транзакция создана и зафиксирована в блоке |
| Перевод C2C (недостаточно средств) | Вызов `create_online_transaction()` с недостаточным балансом | Вызвано исключение `ValueError("Недостаточно средств")`, транзакция не создана |

**Пояснения к таблице 3.5.3:**

Тесты проверяют корректность операций через `exchange_to_digital()`, `create_online_transaction()` с проверкой балансов через `_get_utxo_balance()`, подписанием и финализацией через `_finalize_transaction()`. Система корректно обрабатывает ошибки при недостаточных средствах.

## 3.5.4 Тестирование распределенного реестра

Тестирование распределенного реестра верифицирует целостность цепочки блоков, корректность вычисления хешей и Merkle-корней.

**Таблица 3.5.4 – Тестовые сценарии распределенного реестра**

| Тестовый сценарий | Описание | Ожидаемый результат |
|-------------------|----------|---------------------|
| Целостность цепочки блоков | Вызов `validate_chain()` после создания серии блоков | `is_valid = True`, `invalid_heights = []` |
| Корректность хешей блоков | Вычисление хеша каждого блока и сравнение с сохраненным | Все хеши блоков корректны |
| Обнаружение модификации блока | Изменение данных в блоке и вызов `validate_chain()` | `is_valid = False`, модифицированный блок в `invalid_heights` |
| Корректность Merkle-корня | Сравнение Merkle-корня блока с вычисленным вручную | Merkle-корни совпадают |

**Пояснения к таблице 3.5.4:**

Тесты проверяют целостность реестра через `validate_chain()`, который вычисляет хеши блоков и проверяет связи `previous_hash`. Метод обнаруживает модификации данных через невалидность хешей. Merkle-корни проверяются через функцию `merkle_root()`.

## 3.5.5 Тестирование криптографических механизмов

Тестирование криптографических механизмов верифицирует корректность работы алгоритмов хеширования, подписания и проверки подписей.

**Таблица 3.5.5 – Тестовые сценарии криптографии**

| Тестовый сценарий | Описание | Ожидаемый результат |
|-------------------|----------|---------------------|
| Хеширование Стрибог-256 | Вызов `streebog_256(data)` | 32-байтовый хеш (256 бит) |
| Хеширование SHA-256 | Вызов `hashlib.sha256(payload)` | 32-байтовый хеш (256 бит) |
| Генерация ключевой пары | Вызов `generate_private_key(seed)` и `get_public_key(private_key)` | Приватный ключ (256 бит), публичный ключ (512 бит) |
| Подписание сообщения | Вызов `sign(message_hash, private_key)` | Подпись `{r: hex, s: hex}`, каждая компонента 256 бит |
| Проверка валидной подписи | Вызов `verify(message_hash, signature, public_key)` | `True` |
| Проверка невалидной подписи | Вызов `verify()` с измененным хешем | `False` |

**Пояснения к таблице 3.5.5:**

Тесты проверяют криптографические операции: `streebog_256()` для транзакций, `hashlib.sha256()` для блоков, `generate_private_key()` и `get_public_key()` для генерации ключей, `sign()` и `verify()` для подписания и проверки.

## 3.5.6 Тестирование офлайн-транзакций

Тестирование офлайн-транзакций верифицирует корректность создания транзакций без сетевого подключения, их синхронизации и разрешения конфликтов двойной траты.

**Таблица 3.5.6 – Тестовые сценарии офлайн-транзакций**

| Тестовый сценарий | Описание | Ожидаемый результат |
|-------------------|----------|---------------------|
| Создание офлайн-транзакции | Вызов `create_offline_transaction(sender_id, receiver_id, amount)` | Транзакция создана со статусом "OFFLINE_BUFFER", UTXO заблокирован |
| Успешная синхронизация | Вызов `sync_offline_transactions()` | Транзакция синхронизирована, включена в блок, балансы обновлены |
| Конфликт двойной траты | Создание двух офлайн-транзакций, тратящих одни UTXO | Одна транзакция отклонена, конфликт зафиксирован в `conflict_reason` |

**Пояснения к таблице 3.5.6:**

Тесты проверяют работу офлайн-транзакций: `create_offline_transaction()` создает транзакцию и блокирует UTXO, `sync_offline_transactions()` синхронизирует и финализирует транзакции, система обнаруживает конфликты двойной траты через механизм блокировки UTXO.

## 3.5.7 Тестирование смарт-контрактов

Тестирование смарт-контрактов верифицирует корректность создания контрактов, их автоматического исполнения и обработки ошибок.

**Таблица 3.5.7 – Тестовые сценарии смарт-контрактов**

| Тестовый сценарий | Описание | Ожидаемый результат |
|-------------------|----------|---------------------|
| Создание смарт-контракта | Вызов `create_smart_contract(creator_id, beneficiary_id, amount, schedule)` | Контракт создан, запись в таблице `smart_contracts` с корректными параметрами, `status = "ACTIVE"` |
| Автоматическое исполнение | Вызов `execute_due_contracts()` | Контракт исполнен, транзакция создана и зафиксирована, балансы обновлены, `next_execution` обновлена |
| Обработка ошибки исполнения | Исполнение контракта при недостаточном балансе | Контракт не исполнен, ошибка записана в `failed_transactions`, `status` контракта может быть изменен |

**Пояснения к таблице 3.5.7:**

Тесты проверяют работу смарт-контрактов: `create_smart_contract()` создает контракт со статусом "ACTIVE", `execute_due_contracts()` находит и исполняет контракты с наступившей датой, обновляя `next_execution` для периодических контрактов, система обрабатывает ошибки исполнения через `failed_transactions`.

## 3.5.8 Результаты тестирования

Интеграционное тестирование подтвердило корректность работы всех основных компонентов системы. Все тестовые сценарии выполнены успешно.

**Таблица 3.5.8 – Сводка результатов тестирования**

| Область тестирования | Количество тестов | Успешных | Процент успеха |
|----------------------|-------------------|----------|----------------|
| Моделирование участников | 4 | 4 | 100% |
| Базовые операции | 4 | 4 | 100% |
| Распределенный реестр | 4 | 4 | 100% |
| Криптография | 6 | 6 | 100% |
| Офлайн-транзакции | 3 | 3 | 100% |
| Смарт-контракты | 3 | 3 | 100% |
| **Итого** | **24** | **24** | **100%** |

**Пояснения к таблице 3.5.8:**

Все 24 тестовых сценария выполнены успешно, что подтверждает корректность реализации всех компонентов системы. Тестирование подтвердило правильность работы моделирования участников, базовых операций, распределенного реестра, криптографии, офлайн-транзакций и смарт-контрактов.

## 3.5.9 Верификация функциональности

Верификация функциональности подтверждает, что реализованная система соответствует требованиям и корректно выполняет все заявленные функции.

**Таблица 3.5.9 – Верификация соответствия требованиям**

| Требование | Реализация | Статус верификации |
|------------|------------|-------------------|
| Моделирование участников | Методы `create_users()`, `create_banks()`, `create_government_institutions()` | ✓ Соответствует |
| Базовые операции | Методы `exchange_to_digital()`, `exchange_from_digital()`, `create_online_transaction()` | ✓ Соответствует |
| Распределенный реестр | Класс `DistributedLedger` с методами `append_block()`, `validate_chain()`, `merkle_root()` | ✓ Соответствует |
| Криптография | Модули `gost_3410_2018.py`, `streebog.py`, `key_storage.py` с функциями подписания, проверки, хеширования | ✓ Соответствует |
| Офлайн-транзакции | Методы `create_offline_transaction()`, `sync_offline_transactions()` с механизмом блокировки UTXO | ✓ Соответствует |
| Смарт-контракты | Методы `create_smart_contract()`, `execute_due_contracts()` с автоматическим исполнением | ✓ Соответствует |
| Защита от двойной траты | UTXO-модель с методами `_get_utxos()`, `_spend_utxos()`, `_create_utxo()` и механизмом блокировки | ✓ Соответствует |

**Пояснения к таблице 3.5.9:**

Верификация подтвердила соответствие всех реализованных функций требованиям. Система корректно моделирует участников, обрабатывает базовые операции, обеспечивает целостность данных через распределенный реестр, применяет криптографическую защиту, поддерживает офлайн-транзакции и смарт-контракты, защищает от двойной траты через UTXO-модель.

## 3.5.10 Заключение

Интеграционное тестирование и верификация функциональности подтвердили корректность работы всех компонентов имитационной модели платформы цифрового рубля. Все 24 тестовых сценария выполнены успешно, система соответствует всем требованиям и корректно выполняет заявленные функции. Реализованная модель может быть использована для исследования поведения платформы цифрового рубля в различных сценариях использования.

# Архитектура распределенного реестра и базы данных

## Общая структура

Система цифрового рубля построена на основе распределенного реестра (Distributed Ledger Technology, DLT) с центральным банком (ЦБ) в роли лидера консенсуса и финансовыми организациями (ФО) в роли реплицирующих узлов.

## Узлы сети

### 1. Центральный банк (ЦБ) - Главный узел
- **Роль**: Лидер консенсуса, эмитент, оператор платформы
- **База данных**: `digital_ruble.db`
- **Функции**:
  - Формирование блоков
  - Валидация транзакций
  - Эмиссия цифровых рублей
  - Репликация блоков на узлы ФО
  - Хранение обезличенных данных о токенах и кошельках

### 2. Финансовые организации (ФО) - Реплицирующие узлы
- **Роль**: Репликация блоков, обслуживание клиентов
- **База данных**: `bank_{id}.db` (например, `bank_1.db`, `bank_2.db`)
- **Функции**:
  - Прием и репликация блоков от ЦБ
  - Хранение персональных данных клиентов
  - Хранение детализированной истории транзакций клиентов
  - Обслуживание клиентских операций

## Распределение данных

### Данные, хранящиеся в ЦБ (`digital_ruble.db`)

#### 1. Реестр цифровых рублей (токенов)
- **Таблица `utxos`**: Хранит все UTXO (Unspent Transaction Output)
  - `id`: Уникальный идентификатор UTXO
  - `owner_id`: ID кошелька (ссылка на `wallets.id`)
  - `amount`: Сумма в цифровых рублях
  - `status`: Статус (UNSPENT, SPENT)
  - `created_tx_id`: ID транзакции, создавшей UTXO
  - `spent_tx_id`: ID транзакции, потратившей UTXO
  - `locked_by_tx_id`: ID транзакции, заблокировавшей UTXO

#### 2. Реестр кошельков
- **Таблица `wallets`**: Хранит обезличенную информацию о кошельках
  - `id`: Уникальный идентификатор кошелька
  - `wallet_address`: Адрес кошелька (обезличенный)
  - `bank_id`: ID банка, обслуживающего кошелек
  - `balance`: Баланс в цифровых рублях
  - `wallet_status`: Статус кошелька (OPEN, CLOSED)
  - `offline_balance`: Баланс для оффлайн режима
  - `offline_status`: Статус оффлайн кошелька

#### 3. Реестр транзакций
- **Таблица `transactions`**: Хранит все транзакции в системе
  - `id`: Уникальный идентификатор транзакции
  - `sender_id`: ID пользователя-отправителя (ссылается на `users.id` в БД банков)
  - `receiver_id`: ID пользователя-получателя (ссылается на `users.id` в БД банков)
  - `amount`: Сумма транзакции
  - `tx_type`: Тип транзакции (EXCHANGE, TRANSFER, CONTRACT, OFFLINE)
  - `channel`: Канал транзакции (C2C, B2B, B2C, C2B, FIAT2DR)
  - `status`: Статус транзакции (CONFIRMED, PENDING, OFFLINE_BUFFER)
  - `bank_id`: ID банка, обработавшего транзакцию
  - `hash`: Хеш транзакции
  - `user_sig`: Подпись пользователя (ГОСТ 34.10-2018)
  - `bank_sig`: Подпись банка (ГОСТ 34.10-2018)
  - `cbr_sig`: Подпись ЦБ (ГОСТ 34.10-2018)

#### 4. Блокчейн
- **Таблица `blocks`**: Хранит все блоки распределенного реестра
  - `id`: Уникальный идентификатор блока
  - `height`: Высота блока (номер блока)
  - `hash`: Хеш блока
  - `previous_hash`: Хеш предыдущего блока
  - `merkle_root`: Корень дерева Меркла транзакций
  - `timestamp`: Время создания блока
  - `signer`: Подписант блока (обычно "ЦБ РФ")
  - `nonce`: Nonce для майнинга
  - `duration_ms`: Время создания блока
  - `tx_count`: Количество транзакций в блоке
  - `block_signature`: Подпись блока ЦБ

- **Таблица `block_transactions`**: Связь блоков и транзакций
  - `block_id`: ID блока
  - `tx_id`: ID транзакции

#### 5. Участники платформы
- **Таблица `banks`**: Реестр финансовых организаций
  - `id`: Уникальный идентификатор банка
  - `name`: Название банка
  - `digital_reserve`: Цифровой резерв банка
  - `correspondent_balance`: Корреспондентский счет

#### 6. Смарт-контракты
- **Таблица `smart_contracts`**: Условия и состояние смарт-контрактов
  - `id`: Уникальный идентификатор контракта
  - `creator_id`: ID создателя (ссылается на `users.id` в БД банков)
  - `beneficiary_id`: ID получателя (ссылается на `users.id` в БД банков)
  - `bank_id`: ID банка
  - `amount`: Сумма контракта
  - `schedule`: Расписание выполнения
  - `status`: Статус контракта
  - `required_balance`: Требуемый баланс

#### 7. Оффлайн транзакции
- **Таблица `offline_transactions`**: Оффлайн транзакции, ожидающие синхронизации
  - `id`: Уникальный идентификатор оффлайн транзакции
  - `tx_id`: ID транзакции
  - `status`: Статус (ОФФЛАЙН, ОБРАБОТАНА, КОНФЛИКТ)
  - `synced_at`: Время синхронизации
  - `conflict_reason`: Причина конфликта

#### 8. Системные данные
- **Таблица `metrics`**: Метрики системы
- **Таблица `activity_log`**: Журнал активности
- **Таблица `consensus_events`**: События консенсуса
- **Таблица `failed_transactions`**: Неудачные транзакции
- **Таблица `issuance_requests`**: Запросы на эмиссию

### Данные, хранящиеся в ФО (`bank_{id}.db`)

#### 1. Персональные данные клиентов
- **Таблица `users`**: Хранит персональные данные клиентов
  - `id`: Уникальный идентификатор пользователя (глобально последовательный)
  - `name`: ФИО или название организации
  - `user_type`: Тип пользователя (INDIVIDUAL, BUSINESS, GOVERNMENT)
  - `bank_id`: ID банка (ссылается на `banks.id` в ЦБ, но без FOREIGN KEY)
  - `wallet_id`: ID кошелька (ссылается на `wallets.id` в ЦБ, но без FOREIGN KEY)
  - `fiat_balance`: Баланс безналичных средств
  - `digital_balance`: Баланс цифровых рублей
  - `wallet_status`: Статус цифрового кошелька (OPEN, CLOSED)
  - `offline_balance`: Баланс для оффлайн режима
  - `offline_status`: Статус оффлайн кошелька
  - `offline_activated_at`: Время активации оффлайн режима
  - `offline_expires_at`: Время истечения оффлайн режима
  - `created_at`: Время создания пользователя

#### 2. Детализированная история транзакций
- **Таблица `transactions`**: Реплика всех транзакций, прошедших через банк
  - Те же поля, что и в ЦБ
  - Используется для детализированного анализа операций клиентов

- **Таблица `blocks`**: Реплика всех блоков от ЦБ
  - Те же поля, что и в ЦБ
  - Используется для проверки целостности данных

- **Таблица `block_transactions`**: Связь блоков и транзакций
  - Реплика данных из ЦБ

#### 3. Государственные учреждения
- **Таблица `government_institutions`**: Дополнительная информация о гос. учреждениях
  - `id`: Уникальный идентификатор
  - `user_id`: ID пользователя (FOREIGN KEY на `users.id`)
  - `name`: Название учреждения

#### 4. Пустые таблицы (для совместимости)
- **Таблица `banks`**: Пустая таблица (банки хранятся в ЦБ)

## Процесс репликации блоков

### 1. Формирование блока в ЦБ
1. ЦБ собирает транзакции в пул
2. Валидирует транзакции (проверка подписей, балансов, UTXO)
3. Формирует блок с транзакциями
4. Вычисляет хеш блока и Merkle root
5. Подписывает блок (ГОСТ 34.10-2018)
6. Добавляет блок в свою БД

### 2. Репликация на узлы ФО
1. ЦБ отправляет блок через P2P сеть всем узлам ФО
2. Каждый узел ФО:
   - Валидирует блок локально
   - Проверяет целостность цепочки (previous_hash)
   - Добавляет блок в свою БД
   - Добавляет все транзакции блока в свою БД
   - Связывает транзакции с блоком через `block_transactions`

### 3. Консенсус
- Используется упрощенный алгоритм Raft
- ЦБ является лидером (leader)
- ФО являются последователями (followers)
- Все блоки должны быть реплицированы на все узлы

## Связь между данными

### Связь пользователя и кошелька
- Пользователь (`users` в БД банка) имеет `wallet_id`
- `wallet_id` ссылается на `wallets.id` в БД ЦБ
- ЦБ знает только о кошельках, но не о том, какому человеку они принадлежат
- ФО знает связь "пользователь → кошелек"

### Связь транзакций и пользователей
- Транзакции в ЦБ содержат `sender_id` и `receiver_id`
- Эти ID ссылаются на `users.id` в БД банков
- Для получения персональных данных ЦБ должен запросить информацию у обслуживающей ФО

### Связь UTXO и кошельков
- UTXO хранятся в ЦБ
- `owner_id` в UTXO ссылается на `wallets.id` в ЦБ
- Для определения владельца UTXO нужно:
  1. Найти кошелек по `owner_id` в ЦБ
  2. Найти пользователя по `wallet_id` в БД банка

## Принципы распределения данных

### Принцип обезличенности в ЦБ
- ЦБ видит движение токенов между абстрактными кошельками
- ЦБ не хранит персональные данные клиентов
- Для установления связи "кошелек → человек" требуется запрос к ФО

### Принцип "знай своего клиента" в ФО
- ФО хранят все персональные данные клиентов
- ФО хранят детализированную историю всех операций клиента
- ФО выполняют функции compliance (ПОД/ФТ/ФРОМУ)

### Принцип репликации
- Все блоки реплицируются на все узлы
- Все транзакции реплицируются на все узлы
- Каждый узел имеет полную копию блокчейна
- Это обеспечивает отказоустойчивость и прозрачность

## Безопасность

### Криптография
- Используется ГОСТ 34.10-2018 для цифровых подписей
- Используется Streebog-256 для хеширования
- Каждая транзакция подписывается пользователем и банком
- Каждый блок подписывается ЦБ

### Защита от двойного списания
- UTXO блокируются на время обработки транзакции
- Проверка баланса UTXO перед списанием
- Оффлайн транзакции проверяются при синхронизации

### Целостность данных
- Foreign Key constraints (где возможно)
- Проверка хешей блоков
- Проверка цепочки блоков (previous_hash)
- Валидация транзакций перед включением в блок

## Особенности реализации

### Отключение Foreign Keys
- В некоторых местах foreign keys отключены из-за межбазовых ссылок
- SQLite не поддерживает foreign keys между разными БД
- Валидация целостности выполняется на уровне приложения

### Последовательные ID пользователей
- ID пользователей глобально последовательные (1, 2, 3, ...)
- Перед созданием пользователя вычисляется максимальный ID из всех БД банков
- Новые пользователи получают ID = max_id + 1

### Автоматическое создание UTXO
- Для первой оффлайн транзакции UTXO создается автоматически
- Это позволяет начать оффлайн операции без предварительного пополнения


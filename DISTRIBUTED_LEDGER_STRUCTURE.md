# СТРУКТУРА РАСПРЕДЕЛЕННОГО РЕЕСТРА И БАЗ ДАННЫХ

## ОБЩАЯ АРХИТЕКТУРА

Распределенный реестр цифрового рубля состоит из:
- **1 главный узел (ЦБ)**: `digital_ruble.db` - создает блоки и управляет системой
- **4 узла банков (ФО)**: `bank_1.db`, `bank_2.db`, `bank_3.db`, `bank_4.db` - хранят пользователей и реплицированные блоки

---

## ⚠️ ВАЖНО: Что означает "ТОЛЬКО в ЦБ, НЕ реплицируется на банки"

**"ТОЛЬКО в ЦБ, НЕ реплицируется на банки"** означает:

1. **Данные хранятся только в одной БД** - в `digital_ruble.db` (ЦБ)
2. **Данные НЕ копируются** в БД банков (`bank_1.db`, `bank_2.db` и т.д.)
3. **Банки НЕ имеют доступа** к этим данным напрямую в своих БД
4. **Если банку нужны эти данные**, он должен обратиться к ЦБ (через API или запрос)

### Примеры данных "ТОЛЬКО в ЦБ":

- **Таблица `banks`** - список всех банков
  - Есть только в `digital_ruble.db`
  - Нет в `bank_1.db`, `bank_2.db` и т.д.
  - Банк не знает список других банков из своей БД

- **Таблица `wallets`** - кошельки пользователей
  - Есть только в `digital_ruble.db`
  - Нет в БД банков
  - Банк знает только `wallet_id` своих пользователей, но сам кошелек в ЦБ

### Сравнение с реплицируемыми данными:

**РЕПЛИЦИРУЕТСЯ** (копируется на все банки):
- Таблица `blocks` - каждый банк имеет полную копию блокчейна
- Таблица `transactions` - каждый банк имеет копию всех транзакций

**НЕ РЕПЛИЦИРУЕТСЯ** (только в ЦБ):
- Таблица `banks` - только в ЦБ
- Таблица `wallets` - только в ЦБ
- Таблица `smart_contracts` - только в ЦБ
- Таблица `utxos` - только в ЦБ

### Почему так сделано?

1. **Безопасность**: Конфиденциальные данные (кошельки, UTXO) хранятся централизованно
2. **Производительность**: Не нужно синхронизировать большие объемы данных
3. **Логика**: Банки не должны иметь прямой доступ к кошелькам других банков
4. **Контроль**: ЦБ контролирует критически важные данные

---

---

## 1. БАЗА ДАННЫХ ЦЕНТРАЛЬНОГО БАНКА (digital_ruble.db)

### 1.1. Таблицы инфраструктуры (ТОЛЬКО в ЦБ)

#### `banks` - Информация о финансовых организациях
```
id: INTEGER PRIMARY KEY
name: TEXT UNIQUE NOT NULL
digital_reserve: REAL DEFAULT 0
correspondent_balance: REAL DEFAULT 500000
created_at: TEXT
```
**Назначение:** Хранит информацию о всех банках (ФО) в системе  
**Распределение:** ТОЛЬКО в ЦБ, НЕ реплицируется на банки  
**Взаимодействие:** Банки не имеют доступа к этой таблице напрямую

#### `wallets` - Обезличенные кошельки пользователей
```
id: INTEGER PRIMARY KEY
wallet_address: TEXT UNIQUE NOT NULL
bank_id: INTEGER NOT NULL → FOREIGN KEY → banks(id)
balance: REAL DEFAULT 0
wallet_status: TEXT DEFAULT 'CLOSED'
offline_balance: REAL DEFAULT 0
offline_status: TEXT DEFAULT 'CLOSED'
offline_activated_at: TEXT
offline_expires_at: TEXT
created_at: TEXT
```
**Назначение:** Обезличенные кошельки для цифрового рубля  
**Распределение:** ТОЛЬКО в ЦБ, НЕ реплицируется на банки  
**Взаимодействие:** 
- Создаются в ЦБ при создании пользователя в банке
- Связаны с пользователями через `wallet_id` (хранится в БД банка)
- Пользователи в банках ссылаются на кошельки в ЦБ через `wallet_id`

---

### 1.2. Таблицы блокчейна (ГЛАВНЫЙ РЕЕСТР - реплицируется на банки)

#### `blocks` - Блоки распределенного реестра
```
id: INTEGER PRIMARY KEY
height: INTEGER UNIQUE NOT NULL
hash: TEXT NOT NULL
previous_hash: TEXT
merkle_root: TEXT NOT NULL
timestamp: TEXT NOT NULL
signer: TEXT NOT NULL
nonce: INTEGER NOT NULL
duration_ms: REAL NOT NULL
tx_count: INTEGER NOT NULL
block_signature: TEXT
```
**Назначение:** Главный блокчейн - цепочка блоков с транзакциями  
**Распределение:** 
- **Создается в ЦБ** при формировании нового блока
- **РЕПЛИЦИРУЕТСЯ на все узлы банков** через P2P сеть
- Каждый банк имеет полную копию блокчейна

**Процесс репликации:**
1. ЦБ создает блок с транзакциями
2. ЦБ подписывает блок (block_signature)
3. ЦБ реплицирует блок на все активные узлы банков через `_replicate_block_to_banks()`
4. Каждый банк получает блок и валидирует его
5. Банк вставляет блок в свою БД (таблица `blocks`)
6. Банк вставляет транзакции блока (таблица `transactions`)
7. Банк создает связи блок-транзакция (таблица `block_transactions`)

#### `transactions` - Все транзакции в системе
```
id: TEXT PRIMARY KEY
sender_id: INTEGER (ссылается на users в БД банка)
receiver_id: INTEGER (ссылается на users в БД банка)
amount: REAL NOT NULL
tx_type: TEXT NOT NULL
channel: TEXT NOT NULL
status: TEXT NOT NULL
timestamp: TEXT NOT NULL
bank_id: INTEGER → FOREIGN KEY → banks(id)
hash: TEXT NOT NULL
offline_flag: INTEGER DEFAULT 0
notes: TEXT
user_sig: TEXT
bank_sig: TEXT
cbr_sig: TEXT
```
**Назначение:** Главный реестр всех транзакций  
**Распределение:**
- **Создаются в ЦБ** при обработке транзакций
- **РЕПЛИЦИРУЮТСЯ на банки** вместе с блоками
- Банки получают транзакции для валидации и синхронизации

**Взаимодействие:**
- `sender_id` и `receiver_id` ссылаются на `users.id` в БД банков (не в ЦБ)
- `bank_id` ссылается на `banks.id` в ЦБ
- При репликации блока транзакции вставляются в БД банков

#### `block_transactions` - Связь блоков и транзакций
```
block_id: INTEGER → FOREIGN KEY → blocks(id)
tx_id: TEXT → FOREIGN KEY → transactions(id)
```
**Назначение:** Связывает блоки с транзакциями  
**Распределение:** РЕПЛИЦИРУЕТСЯ вместе с блоками на банки

---

### 1.3. Таблицы цифрового рубля (ТОЛЬКО в ЦБ)

#### `utxos` - Unspent Transaction Outputs (UTXO модель)
```
id: TEXT PRIMARY KEY
owner_id: INTEGER NOT NULL → FOREIGN KEY → wallets(id)
amount: REAL NOT NULL
status: TEXT NOT NULL
created_tx_id: TEXT → FOREIGN KEY → transactions(id)
spent_tx_id: TEXT → FOREIGN KEY → transactions(id)
locked_by_tx_id: TEXT → FOREIGN KEY → transactions(id)
locked_at: TEXT
created_at: TEXT
spent_at: TEXT
```
**Назначение:** UTXO модель для цифрового рубля  
**Распределение:** ТОЛЬКО в ЦБ, НЕ реплицируется  
**Взаимодействие:** Управляет балансами цифрового рубля через UTXO

#### `offline_transactions` - Оффлайн транзакции до синхронизации
```
id: TEXT PRIMARY KEY
tx_id: TEXT → FOREIGN KEY → transactions(id)
status: TEXT NOT NULL
created_at: TEXT
synced_at: TEXT
conflict_reason: TEXT
```
**Назначение:** Оффлайн транзакции до синхронизации с ЦБ  
**Распределение:** ТОЛЬКО в ЦБ

---

### 1.4. Таблицы смарт-контрактов (ТОЛЬКО в ЦБ)

#### `smart_contracts` - Смарт-контракты
```
id: TEXT PRIMARY KEY
creator_id: INTEGER NOT NULL (ссылается на users в БД банка)
beneficiary_id: INTEGER NOT NULL (ссылается на users в БД банка)
bank_id: INTEGER NOT NULL → FOREIGN KEY → banks(id)
amount: REAL NOT NULL
description: TEXT
schedule: TEXT NOT NULL
next_execution: TEXT NOT NULL
status: TEXT NOT NULL
last_execution: TEXT
required_balance: REAL NOT NULL
last_tx_id: TEXT
```
**Назначение:** Смарт-контракты для автоматических платежей  
**Распределение:** ТОЛЬКО в ЦБ, централизованное хранение  
**Взаимодействие:**
- `creator_id` и `beneficiary_id` ссылаются на `users.id` в БД банков
- `bank_id` ссылается на `banks.id` в ЦБ

#### `issuance_requests` - Запросы на эмиссию
```
id: TEXT PRIMARY KEY
bank_id: INTEGER NOT NULL → FOREIGN KEY → banks(id)
amount: REAL NOT NULL
status: TEXT NOT NULL
requested_at: TEXT NOT NULL
processed_at: TEXT
reason: TEXT
```
**Назначение:** Запросы банков на эмиссию цифрового рубля  
**Распределение:** ТОЛЬКО в ЦБ

---

### 1.5. Служебные таблицы (ТОЛЬКО в ЦБ)

- `metrics` - Метрики системы
- `activity_log` - Журнал активности
- `consensus_events` - События консенсуса
- `failed_transactions` - Ошибки транзакций
- `system_errors` - Системные ошибки
- `encryption_keys` - Ключи шифрования

---

## 2. БАЗА ДАННЫХ БАНКА (bank_X.db, где X = ID банка)

### 2.1. Таблицы пользователей (ТОЛЬКО в БД банков, НЕ в ЦБ)

#### `users` - Пользователи банка
```
id: INTEGER PRIMARY KEY
name: TEXT NOT NULL
user_type: TEXT NOT NULL (INDIVIDUAL, BUSINESS, GOVERNMENT)
bank_id: INTEGER (ссылается на banks.id в ЦБ, но без FOREIGN KEY)
wallet_id: INTEGER (ссылается на wallets.id в ЦБ, но без FOREIGN KEY)
fiat_balance: REAL DEFAULT 10000
digital_balance: REAL DEFAULT 0
wallet_status: TEXT DEFAULT 'CLOSED'
offline_balance: REAL DEFAULT 0
offline_status: TEXT DEFAULT 'CLOSED'
offline_activated_at: TEXT
offline_expires_at: TEXT
created_at: TEXT
```
**Назначение:** Пользователи банка (физические лица, юридические лица, госучреждения)  
**Распределение:** 
- **ТОЛЬКО в БД банков**, НЕ в ЦБ
- Каждый банк хранит только своих пользователей
- Это ключевая особенность распределенного реестра

**Взаимодействие:**
- `bank_id` ссылается на `banks.id` в ЦБ (но без FOREIGN KEY, т.к. таблица `banks` отсутствует в БД банка)
- `wallet_id` ссылается на `wallets.id` в ЦБ (но без FOREIGN KEY, т.к. таблица `wallets` отсутствует в БД банка)
- При создании пользователя в банке создается кошелек в ЦБ
- Пользователи распределены по банкам - каждый банк знает только своих клиентов

#### `government_institutions` - Государственные учреждения
```
id: INTEGER PRIMARY KEY
user_id: INTEGER NOT NULL → FOREIGN KEY → users(id)
name: TEXT NOT NULL
created_at: TEXT
```
**Назначение:** Государственные учреждения (подтип пользователей)  
**Распределение:** ТОЛЬКО в БД банков  
**Взаимодействие:** Связаны с пользователями через `user_id` в той же БД банка

---

### 2.2. Таблицы реплицированных данных (РЕПЛИЦИРУЮТСЯ из ЦБ)

#### `blocks` - Реплицированная копия блокчейна
```
id: INTEGER PRIMARY KEY
height: INTEGER UNIQUE NOT NULL
hash: TEXT NOT NULL
previous_hash: TEXT
merkle_root: TEXT NOT NULL
timestamp: TEXT NOT NULL
signer: TEXT NOT NULL
nonce: INTEGER NOT NULL
duration_ms: REAL NOT NULL
tx_count: INTEGER NOT NULL
block_signature: TEXT
```
**Назначение:** Полная копия блокчейна для валидации и синхронизации  
**Распределение:** РЕПЛИЦИРУЕТСЯ из ЦБ на все узлы банков  
**Процесс репликации:**
1. ЦБ создает блок и подписывает его
2. ЦБ отправляет блок на все активные узлы через P2P сеть
3. Банк валидирует блок (проверка хеша, подписи, Merkle root)
4. Банк вставляет блок в свою БД
5. Банк обновляет свою высоту блокчейна

**Взаимодействие:**
- Каждый банк имеет полную копию блокчейна
- Банки могут валидировать транзакции независимо
- Синхронизация происходит через сравнение высоты блокчейна

#### `transactions` - Реплицированная копия транзакций
```
id: TEXT PRIMARY KEY
sender_id: INTEGER (может ссылаться на users в этой БД банка)
receiver_id: INTEGER (может ссылаться на users в этой БД банка)
amount: REAL NOT NULL
tx_type: TEXT NOT NULL
channel: TEXT NOT NULL
status: TEXT NOT NULL
timestamp: TEXT NOT NULL
bank_id: INTEGER (ссылается на banks.id в ЦБ, но без FOREIGN KEY)
hash: TEXT NOT NULL
offline_flag: INTEGER DEFAULT 0
notes: TEXT
user_sig: TEXT
bank_sig: TEXT
cbr_sig: TEXT
```
**Назначение:** Копия транзакций для валидации и синхронизации  
**Распределение:** РЕПЛИЦИРУЕТСЯ вместе с блоками из ЦБ  
**Взаимодействие:**
- `sender_id` и `receiver_id` могут ссылаться на `users.id` в этой БД банка (если транзакция касается пользователей этого банка)
- Банк может проверить транзакции своих пользователей
- Все транзакции реплицируются для поддержания целостности данных

#### `block_transactions` - Связь блоков и транзакций
```
block_id: INTEGER → FOREIGN KEY → blocks(id)
tx_id: TEXT → FOREIGN KEY → transactions(id)
```
**Назначение:** Связь блоков и транзакций  
**Распределение:** РЕПЛИЦИРУЕТСЯ вместе с блоками

---

## 3. ПРОЦЕСС РЕПЛИКАЦИИ БЛОКОВ

### 3.1. Создание блока в ЦБ

```
1. ЦБ собирает транзакции в пул
2. ЦБ формирует блок:
   - Вычисляет Merkle root из транзакций
   - Создает хеш блока
   - Подписывает блок (block_signature)
3. ЦБ вставляет блок в digital_ruble.db:
   - INSERT INTO blocks (height, hash, previous_hash, ...)
   - INSERT INTO transactions (для каждой транзакции)
   - INSERT INTO block_transactions (связь блок-транзакция)
```

### 3.2. Репликация блока на банки

```
Для каждого банка (bank_1.db, bank_2.db, bank_3.db, bank_4.db):
1. ЦБ открывает БД банка: DatabaseManager(f"bank_{bank_id}.db")
2. ЦБ проверяет, не существует ли уже блок:
   SELECT id FROM blocks WHERE height = ?
3. Если блока нет:
   - PRAGMA foreign_keys = OFF (временно отключаем)
   - INSERT INTO blocks (копия блока из ЦБ)
   - INSERT OR IGNORE INTO transactions (копия транзакций)
   - INSERT OR IGNORE INTO block_transactions (связи)
   - PRAGMA foreign_keys = ON
4. Банк получает полную копию блока и транзакций
```

### 3.3. P2P репликация (через сеть)

```
1. ЦБ регистрирует блок в P2P сети
2. P2PNetwork.broadcast_block() отправляет блок на все активные узлы
3. Каждый узел валидирует блок:
   - Проверка хеша
   - Проверка previous_hash
   - Проверка подписи ЦБ
   - Проверка Merkle root
4. Валидированный блок вставляется в БД узла
5. Узел обновляет свою высоту блокчейна
```

---

## 4. ВЗАИМОДЕЙСТВИЕ КОМПОНЕНТОВ

### 4.1. Создание пользователя

```
1. Пользователь создается в БД банка (bank_X.db):
   INSERT INTO users (name, user_type, bank_id, ...)
   
2. В ЦБ создается кошелек:
   INSERT INTO wallets (wallet_address, bank_id, ...)
   
3. В БД банка обновляется wallet_id:
   UPDATE users SET wallet_id = ? WHERE id = ?
   
4. Пользователь связан с кошельком через wallet_id
```

### 4.2. Создание транзакции

```
1. Транзакция создается в ЦБ:
   INSERT INTO transactions (sender_id, receiver_id, amount, ...)
   
2. Транзакция включается в блок:
   INSERT INTO block_transactions (block_id, tx_id)
   
3. Блок реплицируется на банки:
   - Банк получает транзакцию в своей БД
   - Если sender_id или receiver_id относятся к пользователям этого банка,
     банк может обновить их балансы
```

### 4.3. Синхронизация блокчейна

```
1. Банк запрашивает синхронизацию:
   P2PNetwork.request_sync(from_node)
   
2. Сравнение высот блокчейна:
   - ЦБ: SELECT MAX(height) FROM blocks
   - Банк: SELECT MAX(height) FROM blocks
   
3. Если банк отстает:
   - Запрос недостающих блоков
   - Валидация каждого блока
   - Вставка блоков и транзакций в БД банка
   
4. Банк синхронизирован с ЦБ
```

---

## 5. КЛЮЧЕВЫЕ ОСОБЕННОСТИ РАСПРЕДЕЛЕННОГО РЕЕСТРА

### 5.1. Распределение данных

- **Пользователи**: ТОЛЬКО в БД банков, НЕ в ЦБ
- **Блоки**: Создаются в ЦБ, реплицируются на все банки
- **Транзакции**: Создаются в ЦБ, реплицируются на все банки
- **Кошельки**: ТОЛЬКО в ЦБ
- **Банки**: ТОЛЬКО в ЦБ

### 5.2. Репликация по блокам

- Распределение данных идет **именно по блокам**
- Каждый блок содержит набор транзакций
- Блоки реплицируются атомарно (все или ничего)
- Банки получают полную копию блокчейна

### 5.3. Независимость узлов

- Каждый банк имеет свою БД с пользователями
- Каждый банк имеет полную копию блокчейна
- Банки могут валидировать транзакции независимо
- Синхронизация через сравнение высоты блокчейна

### 5.4. Целостность данных

- Блоки подписываются ЦБ (block_signature)
- Валидация блоков на каждом узле
- Merkle root для проверки целостности транзакций
- Foreign keys только внутри одной БД

---

## 6. СХЕМА ВЗАИМОДЕЙСТВИЯ

```
┌─────────────────────────────────────────────────────────────┐
│                    ЦЕНТРАЛЬНЫЙ БАНК                         │
│                  (digital_ruble.db)                         │
├─────────────────────────────────────────────────────────────┤
│ Создает блоки → Реплицирует на банки                        │
│                                                             │
│ Таблицы:                                                    │
│ - banks (только в ЦБ)                                       │
│ - wallets (только в ЦБ)                                     │
│ - blocks (главный реестр) → реплицируется                   │
│ - transactions (главный реестр) → реплицируется             │
│ - smart_contracts (только в ЦБ)                             │
│ - utxos (только в ЦБ)                                       │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ Репликация блоков
                            │ через P2P сеть
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│  БАНК 1      │   │  БАНК 2      │   │  БАНК 3      │
│ (bank_1.db)  │   │ (bank_2.db)  │   │ (bank_3.db)  │
├──────────────┤   ├──────────────┤   ├──────────────┤
│ Таблицы:     │   │ Таблицы:     │   │ Таблицы:     │
│              │   │              │   │              │
│ - users      │   │ - users      │   │ - users      │
│   (только    │   │   (только    │   │   (только    │
│   в банке)   │   │   в банке)   │   │   в банке)   │
│              │   │              │   │              │
│ - blocks     │   │ - blocks     │   │ - blocks     │
│   (реплика)  │   │   (реплика)  │   │   (реплика)  │
│              │   │              │   │              │
│ - trans-     │   │ - trans-     │   │ - trans-     │
│   actions    │   │   actions    │   │   actions    │
│   (реплика)  │   │   (реплика)  │   │   (реплика)  │
└──────────────┘   └──────────────┘   └──────────────┘
```

---

## 7. ПРЕИМУЩЕСТВА РАСПРЕДЕЛЕННОЙ АРХИТЕКТУРЫ

1. **Масштабируемость**: Каждый банк управляет своими пользователями
2. **Надежность**: Полная копия блокчейна на каждом узле
3. **Прозрачность**: Все транзакции реплицируются на все узлы
4. **Валидация**: Каждый узел может независимо валидировать блоки
5. **Синхронизация**: Автоматическая синхронизация через сравнение высоты блокчейна
6. **Безопасность**: Блоки подписываются ЦБ, валидация на каждом узле

---

## ЗАКЛЮЧЕНИЕ

Распределенный реестр цифрового рубля построен на принципе:
- **ЦБ** - создает блоки и управляет системой
- **Банки** - хранят пользователей и реплицированные блоки
- **Репликация** - распределение данных идет именно по блокам
- **Независимость** - каждый узел имеет полную копию блокчейна

Это обеспечивает прозрачность, надежность и масштабируемость системы.


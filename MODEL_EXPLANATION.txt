Модель цифрового рубля: как устроена и работает распределённый реестр
=====================================================================

Общий замысел
-------------
- Всё исполняется на одной машине, но имитируются несколько узлов: ЦБ (`digital_ruble.db`) и банки (`bank_{id}.db`).
- Главный реестр ведётся ЦБ; банки имеют локальные копии. Все операции проходят через ЦБ, затем блоки реплицируются на банки.
- Основные сущности: пользователи, банки, транзакции (онлайн, оффлайн, обмен, смарт‑контракт), UTXO, блоки, связи `block_transactions`.

Формирование блоков
-------------------
- ЦБ собирает подтверждённые транзакции, вычисляет Merkle‑root, формирует заголовок (height, previous_hash, timestamp, nonce, signer) и хеш блока.
- Консенсус упрощён: лидер всегда ЦБ (Raft‑like без выборов). События пишутся в `consensus_events`.
- Подпись блока: в текущей версии верификация отключена по требованию; при этом поле `block_signature` может присутствовать.

Репликация и синхронизация
--------------------------
- Сначала гарантированная (legacy) репликация: ЦБ копирует блок и все транзакции во все `bank_*.db`, создаёт связи `block_transactions`.
- P2P-эмуляция: `P2PNetwork` может дополнительно распространить блоки, читая БД пиров напрямую.
- Синхронизация (pull): узел запрашивает недостающие блоки; добавление делается атомарно (блок + транзакции + связи).

Данные и таблицы
----------------
- `blocks`: height, hash, previous_hash, merkle_root, timestamp, signer, nonce, duration_ms, tx_count, block_signature.
- `transactions`: id, sender_id, receiver_id, amount, tx_type, channel, status, timestamp, bank_id, hash, offline_flag, notes, user_sig, bank_sig, cbr_sig.
- `block_transactions`: связь блок ↔ транзакции.
- `utxos`: модель UTXO для цифрового рубля (UNSPENT/SPENT, created_tx_id, spent_tx_id).
- `smart_contracts`: параметры и статус; `last_tx_id` связывает с транзакцией исполнения.
- `consensus_events`, `activity_log`, `system_errors` — технические журналы.

Онлайн транзакции
-----------------
- Проверка баланса и лимитов, проверка подписей пользователя и банка.
- Создаются с каналом C2C/C2B/B2C/B2B/G2B/B2G/C2G и статусом CONFIRMED; включение в блок выполняется автоматически.
- Связь с блоком фиксируется через `block_transactions`.

Оффлайн транзакции
------------------
- Формируются локально, хранятся в оффлайн-буфере с UTXO.
- При синхронизации ЦБ проверяет подписи, отсутствие двойной траты, затем включает транзакцию в блок и реплицирует блок.

Смарт-контракты
---------------
- Создаются только если у участников открыт цифровой кошелёк; банк подписывает контракт.
- Исполнение генерирует транзакцию типа CONTRACT, которая входит в блок и реплицируется на все узлы.

P2P-уровень (эмуляция)
----------------------
- Узлы известны через `NodeManager` (CBR_0, BANK_1, BANK_2, …).
- `P2PNetwork` имитирует обмен: запросы недостающих блоков, применение с атомарностью БД.
- Проверка подписи блоков отключена; валидация включает только высоту/previous_hash и Merkle‑root.




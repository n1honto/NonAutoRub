================================================================================
СТРУКТУРА ПРОЕКТА "ИМИТАЦИОННАЯ МОДЕЛЬ ЦИФРОВОГО РУБЛЯ"
================================================================================

Этот документ описывает назначение каждого файла проекта, его функции и связи
с другими компонентами системы.

================================================================================
ОСНОВНЫЕ МОДУЛИ ПРИЛОЖЕНИЯ
================================================================================

1. main.py
   Назначение:
   - Главный файл приложения с графическим интерфейсом пользователя (GUI)
   - Реализует интерфейс на базе Tkinter для взаимодействия с платформой
   - Отображает данные о транзакциях, блоках, пользователях, банках и т.д.
   - Предоставляет детальные пояснения по транзакциям и блокам
   
   Основные функции:
   - Создание и управление окнами приложения
   - Отображение таблиц с данными (транзакции, блоки, пользователи, банки)
   - Обработка событий пользователя (создание транзакций, просмотр деталей)
   - Обновление данных в реальном времени
   - Экспорт данных в файлы
   
   Связи:
   - Импортирует: platform.DigitalRublePlatform, consensus.MasterchainConsensus
   - Использует: platform для всех операций с данными
   - Использует: database.DatabaseManager для прямых запросов к БД банков
   - Точка входа в приложение (запускается первым)


2. platform.py
   Назначение:
   - Ядро платформы цифрового рубля
   - Центральный модуль, координирующий работу всех компонентов
   - Реализует бизнес-логику: создание транзакций, управление UTXO, блокчейн
   - Обрабатывает онлайн и оффлайн транзакции
   - Управляет смарт-контрактами
   - Реализует репликацию блоков на все узлы (ФО)
   
   Основные функции:
   - create_online_transaction() - создание онлайн транзакций
   - create_offline_transaction() - создание оффлайн транзакций
   - sync_offline_transactions() - синхронизация оффлайн транзакций
   - execute_due_contracts() - исполнение смарт-контрактов
   - _finalize_transaction() - финализация транзакций
   - _replicate_block_to_banks() - репликация блоков на все узлы
   - _validate_transaction_signatures() - валидация ЭЦП
   
   Связи:
   - Импортирует: database.DatabaseManager, ledger.DistributedLedger
   - Импортирует: consensus.MasterchainConsensus
   - Импортирует: gost_3410_2018 (подписи), streebog (хеширование)
   - Импортирует: batch_processor, transaction_logger (опционально)
   - Импортирует: monitoring.MonitoringSystem, analytics.AnalyticsEngine (опционально)
   - Используется: main.py (основной клиент)


3. database.py
   Назначение:
   - Менеджер базы данных SQLite
   - Абстракция над SQLite для безопасной работы с БД
   - Управление схемой БД, индексами, транзакциями
   - Обеспечивает потокобезопасность
   
   Основные функции:
   - execute() - выполнение SQL запросов
   - _bootstrap_schema() - создание схемы БД
   - _create_indexes() - создание индексов для оптимизации
   - _ensure_columns() - миграция схемы (добавление колонок)
   
   Связи:
   - Используется: platform.py (основной клиент)
   - Используется: ledger.py, consensus.py
   - Используется: monitoring.py, analytics.py
   - Используется: main.py (для прямых запросов к БД банков)
   - Используется: api.py


================================================================================
МОДУЛИ БЛОКЧЕЙНА И КОНСЕНСУСА
================================================================================

4. ledger.py
   Назначение:
   - Реализация распределенного реестра (блокчейна)
   - Управление блоками и их структурой
   - Вычисление Merkle-корня для блоков
   - Связывание блоков в цепочку через хеши
   
   Основные функции:
   - append_block() - добавление нового блока в цепочку
   - get_last_block() - получение последнего блока
   - get_block_by_hash() - поиск блока по хешу
   - merkle_root() - вычисление Merkle-корня
   
   Связи:
   - Импортирует: database.DatabaseManager
   - Используется: platform.py (для создания блоков)
   - Используется: api.py (для восстановления блоков)


5. consensus.py
   Назначение:
   - Реализация консенсус-механизма RAFT
   - Симуляция распределенного консенсуса между узлами
   - Управление событиями консенсуса
   - Голосование и фиксация блоков
   
   Основные функции:
   - run_round() - запуск раунда консенсуса
   - replicate_to_followers() - репликация на последователей
   - append_entries() - добавление записей в лог RAFT
   - get_consensus_events() - получение событий консенсуса
   
   Связи:
   - Импортирует: database.DatabaseManager
   - Используется: platform.py (для фиксации блоков)
   - Используется: main.py (для отображения событий консенсуса)


================================================================================
КРИПТОГРАФИЧЕСКИЕ МОДУЛИ
================================================================================

6. gost_3410_2018.py
   Назначение:
   - Реализация электронной цифровой подписи (ЭЦП) по ГОСТ Р 34.10-2018
   - Генерация ключевых пар (приватный/публичный ключ)
   - Подписание сообщений и проверка подписей
   - Работа с эллиптическими кривыми
   
   Основные функции:
   - generate_private_key() - генерация приватного ключа
   - get_public_key() - получение публичного ключа из приватного
   - sign() - подписание сообщения
   - verify() - проверка подписи
   - signature_to_string() / signature_from_string() - сериализация подписей
   
   Связи:
   - Использует: streebog._streebog_256 (для хеширования сообщений)
   - Используется: platform.py (для подписания транзакций и блоков)
   - Используется: key_storage.py (для хранения приватных ключей)


7. streebog.py
   Назначение:
   - Реализация хеш-функции ГОСТ Р 34.11-2018 (Стрибог)
   - Полная реализация алгоритма Streebog-256 и Streebog-512
   - Используется для хеширования транзакций и блоков
   
   Основные функции:
   - streebog_256() - вычисление 256-битного хеша
   - streebog_512() - вычисление 512-битного хеша
   - streebog_256_hex() - получение хеша в hex формате
   - Внутренние функции: _s_transform, _p_transform, _l_transform, _g_transform
   
   Связи:
   - Используется: gost_3410_2018.py (для хеширования перед подписанием)
   - Используется: platform.py (для хеширования транзакций и блоков)
   - Используется: ledger.py (для вычисления хешей блоков)


8. key_storage.py
   Назначение:
   - Безопасное хранение приватных ключей
   - Шифрование ключей с использованием AES-256-GCM
   - Защита ключей от несанкционированного доступа
   
   Основные функции:
   - store_key() - сохранение зашифрованного ключа
   - load_key() - загрузка и расшифровка ключа
   - Использует PBKDF2 для выведения ключа шифрования
   
   Связи:
   - Использует: pycryptodome (опционально, с fallback)
   - Используется: platform.py (для хранения ключей пользователей и банков)
   - Связан с: gost_3410_2018.py (работа с ключами)


================================================================================
МОДУЛИ ОПТИМИЗАЦИИ И МОНИТОРИНГА
================================================================================

9. batch_processor.py
   Назначение:
   - Батч-обработка транзакций, оффлайн-транзакций и контрактов
   - Группировка операций для повышения производительности
   - Асинхронная обработка в фоновых потоках
   
   Основные классы:
   - BatchProcessor - базовый класс для батч-обработки
   - TransactionBatchProcessor - обработка транзакций батчами
   - OfflineTransactionBatchProcessor - обработка оффлайн-транзакций
   - ContractBatchProcessor - обработка контрактов
   
   Связи:
   - Используется: platform.py (для батч-обработки операций)
   - Работает в фоновых потоках для неблокирующей обработки


10. transaction_logger.py
    Назначение:
    - Детальное логирование жизненного цикла транзакций
    - Отслеживание всех этапов обработки транзакции
    - Структурированное логирование для анализа и отладки
    
    Основные функции:
    - log_initiation() - логирование инициации транзакции
    - log_core_formation() - логирование формирования core
    - log_hash_calculation() - логирование вычисления хеша
    - log_user_signature() / log_bank_signature() - логирование подписей
    - log_utxo_processing() - логирование обработки UTXO
    - log_block_inclusion() - логирование включения в блок
    - log_replication() - логирование репликации
    - log_finalization() - логирование финализации
    
    Связи:
    - Используется: platform.py (для детального логирования транзакций)
    - Использует: platform._log_activity() для записи в БД


11. transactions_module.py
    Назначение:
    - Вспомогательный модуль для работы с транзакциями
    - Содержит вспомогательные функции (может быть пустым или содержать утилиты)
    
    Связи:
    - Может использоваться: platform.py (для рефакторинга)


================================================================================
СХЕМА СВЯЗЕЙ МЕЖДУ МОДУЛЯМИ
================================================================================

main.py (GUI)
    │
    ├──> platform.py (Ядро)
    │       │
    │       ├──> database.py (БД)
    │       │       └──> SQLite файлы (.db)
    │       │
    │       ├──> ledger.py (Блокчейн)
    │       │       └──> database.py
    │       │
    │       ├──> consensus.py (Консенсус)
    │       │       └──> database.py
    │       │
    │       ├──> gost_3410_2018.py (ЭЦП)
    │       │       └──> streebog.py (Хеширование)
    │       │
    │       ├──> key_storage.py (Хранение ключей)
    │       │       └──> gost_3410_2018.py
    │       │
    │       ├──> batch_processor.py (Батч-обработка)
    │       │
    │       └──> transaction_logger.py (Логирование)
    │               └──> database.py
    │
    └──> database.py (прямые запросы к БД банков)


================================================================================
ПОТОК ДАННЫХ ПРИ СОЗДАНИИ ТРАНЗАКЦИИ
================================================================================

1. main.py: Пользователь создает транзакцию через GUI
   │
   └──> platform.py: create_online_transaction()
        │
        ├──> transaction_logger.py: log_initiation() (детальное логирование)
        │
        ├──> _create_transaction_record()
        │   │
        │   ├──> streebog.py: streebog_256_hex() (хеширование)
        │   │
        │   ├──> gost_3410_2018.py: sign() (подписание ЭЦП)
        │   │   └──> streebog.py: _streebog_256() (хеш для подписи)
        │   │
        │   └──> database.py: execute() (сохранение в БД)
        │
        ├──> _finalize_transaction()
        │   │
        │   ├──> transaction_logger.py: log_utxo_processing()
        │   │
        │   ├──> ledger.py: append_block() (создание блока)
        │   │   └──> streebog.py: streebog_256_hex() (хеш блока)
        │   │
        │   ├──> consensus.py: run_round() (консенсус)
        │   │   └──> database.py: execute() (события консенсуса)
        │   │
        │   ├──> _replicate_block_to_banks() (репликация)
        │   │   └──> database.py: execute() (БД банков)
        │   │
        │   └──> transaction_logger.py: log_finalization()
        │


================================================================================
БАЗЫ ДАННЫХ
================================================================================

digital_ruble.db
    - Главная база данных (центральный реестр)
    - Содержит: транзакции, блоки, пользователи, банки, UTXO, контракты
    - Управляется: database.DatabaseManager (по умолчанию)

bank_1.db, bank_2.db, ...
    - Локальные базы данных финансовых организаций (ФО)
    - Полная репликация всех блоков и транзакций
    - Управляются: database.DatabaseManager(f"bank_{id}.db")
    - Создаются: platform._replicate_block_to_banks()


================================================================================
ОПЦИОНАЛЬНЫЕ ЗАВИСИМОСТИ
================================================================================

pycryptodome
    - Используется: key_storage.py (для AES-256-GCM шифрования)
    - Если отсутствует: используется fallback (менее безопасный)

batch_processor.py, transaction_logger.py
    - Опциональные модули для оптимизации
    - Если отсутствуют: platform.py работает без них (graceful degradation)


================================================================================
ТОЧКА ВХОДА
================================================================================

main.py
    - Файл запуска приложения
    - Создает экземпляр DigitalRubleApp
    - Инициализирует GUI и платформу
    - Запускается командой: python main.py


================================================================================
КЛЮЧЕВЫЕ ОСОБЕННОСТИ АРХИТЕКТУРЫ
================================================================================

1. Модульность: Каждый модуль отвечает за свою область функциональности
2. Разделение ответственности: GUI отделен от бизнес-логики
3. Graceful degradation: Опциональные модули не ломают систему при отсутствии
4. Потокобезопасность: database.py обеспечивает безопасную работу с БД
5. Полная репликация: Все блоки реплицируются на все узлы (ФО)
6. Криптография: ГОСТ 34.10-2018 (ЭЦП) + ГОСТ 34.11-2018 (Стрибог)
7. Консенсус: RAFT для фиксации блоков
8. Батч-обработка: Асинхронная обработка для производительности
9. Детальное логирование: Полный жизненный цикл транзакций


================================================================================
СХЕМА ФУНКЦИОНИРОВАНИЯ БАЗЫ ДАННЫХ РАСПРЕДЕЛЕННОГО РЕЕСТРА
================================================================================

АРХИТЕКТУРА РАСПРЕДЕЛЕННОГО РЕЕСТРА
------------------------------------

Система использует модель "Центральный реестр + Полная репликация":

┌─────────────────────────────────────────────────────────────────┐
│              ЦЕНТРАЛЬНЫЙ РЕЕСТР (ЦБ РФ)                          │
│                    digital_ruble.db                              │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Таблицы:                                                  │   │
│  │  • users (пользователи)                                   │   │
│  │  • banks (финансовые организации)                         │   │
│  │  • transactions (все транзакции)                         │   │
│  │  • blocks (все блоки)                                     │   │
│  │  • block_transactions (связи блок-транзакция)            │   │
│  │  • utxos (непотраченные выходы)                           │   │
│  │  • smart_contracts (смарт-контракты)                      │   │
│  │  • offline_transactions (оффлайн транзакции)              │   │
│  │  • consensus_events (события консенсуса)                  │   │
│  │  • activity_log (журнал активности)                       │   │
│  │  • metrics (метрики)                                      │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ ПОЛНАЯ РЕПЛИКАЦИЯ
                              │ (все блоки и транзакции)
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│  ФО #1       │      │  ФО #2       │      │  ФО #N       │
│ bank_1.db    │      │ bank_2.db    │      │ bank_N.db    │
│              │      │              │      │              │
│ ┌──────────┐ │      │ ┌──────────┐ │      │ ┌──────────┐ │
│ │ Таблицы: │ │      │ │ Таблицы: │ │      │ │ Таблицы: │ │
│ │ • blocks │ │      │ │ • blocks │ │      │ │ • blocks │ │
│ │ • trans- │ │      │ │ • trans- │ │      │ │ • trans- │ │
│ │   actions│ │      │ │   actions│ │      │ │   actions│ │
│ │ • block_ │ │      │ │ • block_ │ │      │ │ • block_ │ │
│ │   trans- │ │      │ │   trans- │ │      │ │   trans- │ │
│ │   actions│ │      │ │   actions│ │      │ │   actions│ │
│ └──────────┘ │      │ └──────────┘ │      │ └──────────┘ │
└──────────────┘      └──────────────┘      └──────────────┘


ПРОЦЕСС РЕПЛИКАЦИИ БЛОКОВ
--------------------------

1. СОЗДАНИЕ БЛОКА В ЦЕНТРАЛЬНОМ РЕЕСТРЕ
   ┌─────────────────────────────────────────┐
   │ platform._finalize_transaction()        │
   │   └─> ledger.append_block()             │
   │       └─> database.execute()            │
   │           INSERT INTO blocks (...)      │
   │           INSERT INTO block_transactions│
   └─────────────────────────────────────────┘

2. КОНСЕНСУС (RAFT)
   ┌─────────────────────────────────────────┐
   │ consensus.run_round()                   │
   │   └─> Запись в consensus_events         │
   │   └─> Голосование узлов                 │
   │   └─> Фиксация блока (COMMITTED)        │
   └─────────────────────────────────────────┘

3. РЕПЛИКАЦИЯ НА ВСЕ УЗЛЫ
   ┌─────────────────────────────────────────┐
   │ platform._replicate_block_to_banks()    │
   │                                         │
   │ Для каждого банка (ФО):                 │
   │   1. Открыть bank_{id}.db               │
   │   2. Проверить существование блока      │
   │   3. Если блока нет:                    │
   │      a) INSERT INTO blocks              │
   │      b) INSERT INTO transactions        │
   │         (все транзакции блока)          │
   │      c) INSERT INTO block_transactions  │
   │         (связи блок-транзакция)         │
   └─────────────────────────────────────────┘


СТРУКТУРА ТАБЛИЦ В КАЖДОЙ БД
----------------------------

ЦЕНТРАЛЬНЫЙ РЕЕСТР (digital_ruble.db):
  • users              - Пользователи системы
  • banks              - Финансовые организации
  • transactions       - Все транзакции
  • blocks            - Все блоки
  • block_transactions - Связи блок-транзакция
  • utxos              - Непотраченные выходы (UTXO)
  • smart_contracts   - Смарт-контракты
  • offline_transactions - Оффлайн транзакции
  • consensus_events  - События консенсуса
  • activity_log      - Журнал активности
  • metrics           - Метрики системы
  • failed_transactions - Неудачные транзакции
  • system_errors     - Системные ошибки
  • encryption_keys   - Ключи шифрования

ЛОКАЛЬНЫЕ БД БАНКОВ (bank_{id}.db):
  • blocks            - ВСЕ блоки (полная репликация)
  • transactions      - ВСЕ транзакции из всех блоков
  • block_transactions - Связи блок-транзакция


ПРИНЦИПЫ РАБОТЫ РАСПРЕДЕЛЕННОГО РЕЕСТРА
----------------------------------------

1. ЕДИНЫЙ ИСТОЧНИК ИСТИНЫ
   - Центральный реестр (digital_ruble.db) - единственный источник истины
   - Все транзакции сначала создаются в центральном реестре
   - Все блоки сначала создаются в центральном реестре

2. ПОЛНАЯ РЕПЛИКАЦИЯ
   - Каждый блок реплицируется на ВСЕ узлы (ФО)
   - Каждая транзакция реплицируется на ВСЕ узлы
   - Независимо от того, через какой банк прошла транзакция
   - Каждый узел имеет полную копию всех блоков

3. СВЯЗИ МЕЖДУ БЛОКАМИ
   - Каждый блок содержит previous_hash (хеш предыдущего блока)
   - Блоки связаны в цепочку через хеши
   - Можно восстановить цепочку, начиная с любого блока
   - Merkle-корень связывает все транзакции блока

4. ВАЛИДАЦИЯ И КОНСЕНСУС
   - Перед репликацией блок проходит консенсус (RAFT)
   - Все узлы проверяют валидность блока
   - Блок фиксируется только после достижения кворума
   - События консенсуса записываются в consensus_events

5. ЦЕЛОСТНОСТЬ ДАННЫХ
   - Foreign keys обеспечивают целостность связей
   - Хеши блоков обеспечивают неизменяемость
   - ЭЦП обеспечивают подлинность транзакций
   - Индексы ускоряют поиск и валидацию


ПРОЦЕСС ВОССТАНОВЛЕНИЯ БЛОКА
-----------------------------

1. ПОИСК БЛОКА ПО ХЕШУ
   SELECT * FROM blocks WHERE hash = ?

2. ПОИСК БЛОКА ПО ПРЕДЫДУЩЕМУ ХЕШУ
   SELECT * FROM blocks WHERE previous_hash = ?

3. ВОССТАНОВЛЕНИЕ ЦЕПОЧКИ
   - Начать с блока по хешу
   - Найти следующий блок по previous_hash
   - Повторять до конца цепочки
   - Получить все транзакции через block_transactions


ОПТИМИЗАЦИЯ БД
---------------

ИНДЕКСЫ (создаются автоматически):
  • idx_transactions_hash - быстрый поиск транзакций по хешу
  • idx_transactions_timestamp - сортировка по времени
  • idx_transactions_sender/receiver - поиск по участникам
  • idx_blocks_previous_hash - восстановление цепочки
  • idx_blocks_height - поиск по высоте блока
  • idx_utxos_owner_status - поиск доступных UTXO
  • idx_block_transactions_block_id/tx_id - связи блок-транзакция
  • idx_consensus_events_block_hash - события консенсуса
  • idx_activity_log_created_at - журнал активности

СВЯЗИ (Foreign Keys):
  • transactions → users (sender_id, receiver_id)
  • transactions → banks (bank_id)
  • block_transactions → blocks (block_id)
  • block_transactions → transactions (tx_id)
  • utxos → users (owner_id)
  • utxos → transactions (created_tx_id, spent_tx_id)


ПОТОК ДАННЫХ ПРИ РЕПЛИКАЦИИ
-----------------------------

1. Транзакция создается → digital_ruble.db (transactions)
2. Транзакция включается в блок → digital_ruble.db (blocks, block_transactions)
3. Консенсус → digital_ruble.db (consensus_events)
4. Репликация → bank_1.db, bank_2.db, ..., bank_N.db
   - Блок копируется в каждую БД банка
   - Все транзакции блока копируются в каждую БД банка
   - Связи block_transactions копируются в каждую БД банка

РЕЗУЛЬТАТ:
  - Каждый узел (ФО) имеет полную копию всех блоков
  - Каждый узел может восстановить всю цепочку блоков
  - Каждый узел может проверить валидность любой транзакции
  - Отказ одного узла не влияет на работу других


================================================================================
КОНЕЦ ДОКУМЕНТА
================================================================================


# Улучшения распределенного реестра

## Обзор изменений

Распределенный реестр был преобразован из централизованной модели с односторонней репликацией в настоящую распределенную P2P сеть с независимыми узлами.

## Что является узлом распределенного реестра?

**Узел** - это независимый участник распределенной сети, который имеет:
- Свою собственную базу данных (БД) с полной копией блокчейна
- Уникальный идентификатор (node_id)
- Возможность валидировать и хранить блоки
- Возможность синхронизироваться с другими узлами

### Типы узлов в системе:

1. **Центральный банк (ЦБ РФ)** - тип `CBR`
   - Главный узел системы
   - Имеет БД: `digital_ruble.db`
   - Node ID: `CBR_0` (по умолчанию)
   - Создает блоки и распространяет их в сети
   - Имеет полномочия на создание новых блоков

2. **Финансовые организации (Банки)** - тип `BANK`
   - Узлы финансовых организаций
   - Имеют БД: `bank_{id}.db` (например, `bank_1.db`, `bank_2.db`)
   - Node ID: `BANK_{id}` (например, `BANK_1`, `BANK_2`)
   - Валидируют блоки от других узлов
   - Могут синхронизироваться с сетью
   - Хранят полную копию блокчейна
   - **Важно:** Все узлы (и ЦБ, и банки) автоматически валидируют все блоки перед добавлением в свою БД

### Структура узла:

Каждый узел содержит:
```python
NodeInfo(
    node_id="CBR_0" или "BANK_1",
    name="ЦБ РФ (Главный узел)" или "Финансовая организация 1",
    node_type="CBR" или "BANK",
    db_path="digital_ruble.db" или "bank_1.db",
    address="local://digital_ruble.db",
    status=NodeStatus.ACTIVE,
    height=100,  # Текущая высота блокчейна
    last_block_hash="abc123...",
    registered_at="2024-01-01T00:00:00",
    public_key=None  # Для верификации подписей
)
```

### Физическое представление узла:

**Узел = Экземпляр платформы + База данных**

- Каждый узел - это отдельный экземпляр `DigitalRublePlatform` с собственной БД
- Узлы могут работать на разных машинах (в текущей реализации - на одной машине, но с разными БД)
- Каждый узел независимо валидирует блоки перед добавлением в свою БД
- Узлы обмениваются блоками через P2P сеть

## Основные улучшения

### 1. Управление узлами сети (`node_manager.py`)

**Новые возможности:**
- Регистрация независимых узлов с уникальными идентификаторами
- Отслеживание статусов узлов (ACTIVE, INACTIVE, SYNCING, DISCONNECTED)
- Хранение информации о высоте блокчейна каждого узла
- Управление соединениями между узлами
- Обнаружение новых узлов в сети

**Ключевые классы:**
- `NodeManager` - управление узлами сети
- `NodeInfo` - информация об узле
- `NodeStatus` - статусы узлов

### 2. P2P коммуникация (`p2p_network.py`)

**Новые возможности:**
- Распространение блоков на все узлы сети (broadcast)
- Синхронизация блокчейна между узлами
- Валидация блоков перед добавлением на узел
- Обмен транзакциями между узлами
- Автоматическая синхронизация с сетью

**Ключевые классы:**
- `P2PNetwork` - P2P сеть для обмена данными
- `BlockMessage` - сообщение с блоком для передачи
- `SyncRequest` / `SyncResponse` - запросы и ответы синхронизации

**Процесс распространения блока:**
1. Блок создается на одном узле
2. Блок валидируется локально
3. Блок распространяется на все активные узлы через P2P сеть
4. Каждый узел валидирует блок перед добавлением
5. Узлы обновляют свою информацию о состоянии сети

### 3. Разрешение конфликтов (`fork_resolution.py`)

**Новые возможности:**
- Обнаружение форков (расхождений цепочек)
- Автоматическое разрешение конфликтов по правилу самой длинной цепочки
- Переключение на более длинную цепочку при расхождении
- Валидация цепочек перед переключением

**Ключевые классы:**
- `ForkResolver` - разрешение конфликтов
- `ForkInfo` - информация о форке

**Стратегия разрешения:**
- Выбирается самая длинная цепочка (longest chain rule)
- При равенстве длин выбирается цепочка с более ранним timestamp последнего блока
- Блоки от точки расхождения удаляются и заменяются новой цепочкой

### 4. Расширенный функционал реестра (`ledger.py`)

**Новые методы:**
- `get_chain_tip()` - получение последнего блока
- `get_chain_length()` - получение длины цепочки
- `find_common_ancestor()` - поиск общего предка с другой цепочкой
- `get_blocks_from_height()` - получение блоков в диапазоне высот
- `has_block()` - проверка наличия блока
- `get_block_height()` - получение высоты блока по хешу

### 5. Интеграция в платформу (`platform.py`)

**Изменения:**
- Инициализация распределенной сети при создании платформы
- Автоматическая регистрация узлов при создании банков
- Использование P2P сети для распространения блоков
- Метод `sync_with_network()` для синхронизации с сетью
- Обратная совместимость со старым методом репликации

## Архитектура распределенного реестра

### До улучшений:
```
┌─────────────────┐
│  Центральный    │
│  реестр (ЦБ)    │
│  digital_ruble  │
│      .db        │
└────────┬────────┘
         │
         │ Репликация (односторонняя)
         │
    ┌────┴────┬──────────┐
    │         │          │
┌───▼───┐ ┌──▼───┐  ┌───▼───┐
│Банк 1 │ │Банк 2│  │Банк N │
│bank_1 │ │bank_2│  │bank_N │
│  .db  │ │ .db  │  │  .db  │
└───────┘ └──────┘  └───────┘
(только реплики, не могут создавать блоки)
```

### После улучшений:
```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│   Узел 1    │◄────►│   Узел 2    │◄────►│   Узел N    │
│  (ЦБ РФ)    │      │  (Банк 1)   │      │  (Банк N)   │
│             │      │             │      │             │
│ Создает     │      │ Валидирует  │      │ Валидирует  │
│ блоки       │      │ блоки       │      │ блоки       │
│             │      │             │      │             │
│ Синхронизи- │      │ Синхронизи- │      │ Синхронизи- │
│ руется с    │      │ руется с    │      │ руется с    │
│ другими     │      │ другими     │      │ другими     │
└─────────────┘      └─────────────┘      └─────────────┘
      ▲                    ▲                    ▲
      │                    │                    │
      └────────────────────┴────────────────────┘
              P2P Сеть (двусторонняя)
```

## Преимущества новой архитектуры

1. **Истинная распределенность**: Каждый узел независим и может валидировать блоки
2. **Отказоустойчивость**: При отказе одного узла система продолжает работать
3. **Прозрачность**: Все узлы имеют полную копию блокчейна
4. **Безопасность**: Валидация блоков на каждом узле перед добавлением
5. **Масштабируемость**: Легко добавлять новые узлы в сеть
6. **Автоматическая синхронизация**: Узлы автоматически синхронизируются друг с другом
7. **Разрешение конфликтов**: Автоматическое разрешение форков

## Использование

### Создание платформы с распределенной сетью:
```python
platform = DigitalRublePlatform(node_id="CBR_0", db_path="digital_ruble.db")
```

### Синхронизация с сетью:
```python
results = platform.sync_with_network()
print(f"Добавлено блоков: {results['blocks_added']}")
print(f"Проверено узлов: {results['nodes_checked']}")
```

### Получение информации об узлах:
```python
node_manager = platform.node_manager
active_nodes = node_manager.get_active_nodes()
stats = node_manager.get_node_statistics()
```

## Обратная совместимость

Система полностью обратно совместима:
- Если модули распределенной сети недоступны, используется старый метод репликации
- Существующие базы данных продолжают работать
- Все существующие функции платформы работают как прежде

## Дальнейшие улучшения

Возможные направления для дальнейшего развития:
1. Реализация реальной сетевой коммуникации (TCP/IP, WebSocket)
2. Механизм обнаружения узлов через broadcast или registry
3. Оптимизация синхронизации (инкрементальная синхронизация)
4. Механизм консенсуса между узлами (улучшение Raft)
5. Шифрование коммуникации между узлами
6. Мониторинг состояния сети в реальном времени

